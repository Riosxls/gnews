name: Gemini Code Analysis

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Python Dependencies
        run: pip install -q -U google-generativeai

      - name: Send Code to Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          python - <<EOF
          import os
          import google.generativeai as genai

          genai.configure(api_key=os.environ["GEMINI_API_KEY"])
          model = genai.GenerativeModel('gemini-2.5-flash')

          # Captura as mudanÃ§as do PR (diff)
          diff = os.popen("git diff origin/${{ github.base_ref }} HEAD").read()

          prompt = f"Aja como um sÃªnior developer. Analise o seguinte diff de um Pull Request e sugira melhorias ou aponte erros:\n\n{diff}"
          
          response = model.generate_content(prompt)
          print(response.text)
          
          # Salva a resposta para o prÃ³ximo passo
          with open("gemini_report.md", "w") as f:
              f.write("### ðŸ¤– Gemini Code Review\n")
              f.write(response.text)
          EOF

      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: gemini_report.md
